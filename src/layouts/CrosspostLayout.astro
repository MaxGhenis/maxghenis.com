---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';

interface Props {
	title: string;
	description: string;
	pubDate: Date;
	originalUrl: string;
	heroImage?: string;
}

const { title, description, pubDate, originalUrl, heroImage } = Astro.props;
---

<html lang="en">
	<head>
		<BaseHead title={`${title} (Crosspost)`} description={description} />
	</head>
	<body>
		<Header />
		<main>
			<article>
				<header class="crosspost-header">
					<div class="crosspost-badge">Crosspost version</div>
					<h1>{title}</h1>
					<p class="description">{description}</p>

					{heroImage && (
						<div class="hero-image-section">
							<img src={heroImage} alt={`Cover image for ${title}`} class="hero-image" />
							<a href={heroImage} download={`${title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-cover.png`} class="download-link">
								<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
									<path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
								</svg>
								Download cover image
							</a>
						</div>
					)}

					<div class="actions">
						<button id="copy-btn" class="copy-btn">
							<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
								<path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
							</svg>
							Copy text &amp; links
						</button>
						<a href={originalUrl} class="original-link">
							<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
								<path fill="currentColor" d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
							</svg>
							View original with interactive content
						</a>
					</div>
					<p class="image-note">Note: Images need to be added manually after pasting. Right-click images below to save them.</p>
				</header>

				<div id="copyable-content" class="copyable-content">
					<slot />
				</div>

				<footer class="crosspost-footer">
					<a href="/blog" class="back-link">
						<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
							<path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
						</svg>
						Back to all posts
					</a>
				</footer>
			</article>
		</main>
		<Footer />

		<!-- Toast notification -->
		<div id="toast" class="toast">Copied to clipboard!</div>
	</body>
</html>

<script>
	const copyBtn = document.getElementById('copy-btn');
	const content = document.getElementById('copyable-content');
	const toast = document.getElementById('toast');
	const titleEl = document.querySelector('.crosspost-header h1');
	const subtitleEl = document.querySelector('.crosspost-header .description');

	copyBtn?.addEventListener('click', async () => {
		if (!content) return;

		try {
			// Clone content
			const clone = content.cloneNode(true) as HTMLElement;
			const baseUrl = window.location.origin;

			// Fix link URLs (in case any are relative)
			clone.querySelectorAll('a').forEach(a => {
				const href = a.getAttribute('href');
				if (href && href.startsWith('/')) {
					a.setAttribute('href', baseUrl + href);
				}
			});

			// Remove images from the copy (platforms don't support pasted HTML images)
			// Users should add images manually using each platform's upload
			clone.querySelectorAll('img').forEach(img => {
				const alt = img.getAttribute('alt') || 'Image';
				const placeholder = document.createElement('p');
				placeholder.innerHTML = `<em>[Image: ${alt}]</em>`;
				placeholder.style.color = '#666';
				img.replaceWith(placeholder);
			});

			// Fix list structure: unwrap <p> inside <li> (Medium misinterprets nested structure)
			clone.querySelectorAll('li > p').forEach(p => {
				const li = p.parentElement;
				if (li && p.parentElement === li) {
					// Move p's children directly into li, remove the p wrapper
					while (p.firstChild) {
						li.insertBefore(p.firstChild, p);
					}
					p.remove();
				}
			});

			// Remove any wrapper divs that might cause formatting issues
			clone.querySelectorAll('div').forEach(div => {
				// Replace div with its children
				const parent = div.parentElement;
				if (parent) {
					while (div.firstChild) {
						parent.insertBefore(div.firstChild, div);
					}
					div.remove();
				}
			});

			// Build HTML - don't include title as <h1> since Medium interprets it incorrectly
			// Users should manually enter the title in Medium's title field
			// Include subtitle as the first paragraph
			const subtitle = subtitleEl?.textContent || '';
			const subtitleHtml = subtitle ? `<p><em>${subtitle}</em></p>\n` : '';
			const html = subtitleHtml + clone.innerHTML;
			const text = (subtitle ? subtitle + '\n\n' : '') + content.innerText;

			// Try to copy as rich HTML (preserves links and formatting)
			try {
				await navigator.clipboard.write([
					new ClipboardItem({
						'text/html': new Blob([html], { type: 'text/html' }),
						'text/plain': new Blob([text], { type: 'text/plain' }),
					}),
				]);
			} catch {
				// Fallback to plain text if rich copy fails
				await navigator.clipboard.writeText(text);
			}

			// Show toast
			toast?.classList.add('show');
			setTimeout(() => {
				toast?.classList.remove('show');
			}, 2000);

			// Update button
			copyBtn.innerHTML = `
				<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
					<path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
				</svg>
				Copied!
			`;
			setTimeout(() => {
				copyBtn.innerHTML = `
					<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
						<path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
					</svg>
					Copy text &amp; links
				`;
			}, 2000);
		} catch (err) {
			console.error('Failed to copy:', err);
			// Reset button on error
			copyBtn.innerHTML = `
				<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
					<path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
				</svg>
				Copy text &amp; links
			`;
		}
	});
</script>

<style>
	main {
		max-width: 100%;
		padding: 0;
	}

	article {
		max-width: 720px;
		margin: 0 auto;
		padding: var(--space-xl) var(--space-lg);
	}

	/* Header */
	.crosspost-header {
		text-align: center;
		margin-bottom: 2rem;
		padding-bottom: 2rem;
		border-bottom: 1px solid rgba(15, 23, 42, 0.08);
	}

	.crosspost-badge {
		display: inline-block;
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.1em;
		color: var(--amber-dark);
		background: var(--amber-light);
		padding: 0.25rem 0.75rem;
		border-radius: var(--radius-full);
		margin-bottom: 1rem;
	}

	.crosspost-header h1 {
		font-size: 2rem;
		line-height: 1.3;
		margin-bottom: 0.75rem;
		letter-spacing: -0.02em;
	}

	.description {
		font-size: 1.125rem;
		color: var(--text-secondary);
		margin-bottom: 1.5rem;
		line-height: 1.5;
	}

	.hero-image-section {
		margin-bottom: 1.5rem;
		text-align: center;
	}

	.hero-image {
		max-width: 100%;
		height: auto;
		border-radius: var(--radius-lg);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		margin-bottom: 0.75rem;
	}

	.download-link {
		display: inline-flex;
		align-items: center;
		gap: 0.375rem;
		font-size: 0.875rem;
		color: var(--text-secondary);
		text-decoration: none;
		transition: color var(--duration-fast) var(--ease-out);
	}

	.download-link:hover {
		color: var(--amber-dark);
	}

	.actions {
		display: flex;
		flex-wrap: wrap;
		gap: 1rem;
		justify-content: center;
	}

	.image-note {
		font-size: 0.875rem;
		color: var(--text-secondary);
		margin-top: 1rem;
		font-style: italic;
	}

	.copy-btn {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.75rem 1.25rem;
		font-size: 0.9375rem;
		font-weight: 600;
		color: white;
		background: var(--amber-dark);
		border: none;
		border-radius: var(--radius-lg);
		cursor: pointer;
		transition: all var(--duration-fast) var(--ease-out);
	}

	.copy-btn:hover {
		background: var(--amber-medium);
		transform: translateY(-1px);
	}

	.original-link {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.75rem 1.25rem;
		font-size: 0.9375rem;
		font-weight: 600;
		color: var(--text-secondary);
		background: var(--bg-secondary);
		border-radius: var(--radius-lg);
		text-decoration: none;
		transition: all var(--duration-fast) var(--ease-out);
	}

	.original-link:hover {
		color: var(--amber-dark);
		background: var(--bg-tertiary);
	}

	/* Copyable content area */
	.copyable-content {
		background: var(--bg-secondary);
		border: 1px solid rgba(15, 23, 42, 0.08);
		border-radius: var(--radius-lg);
		padding: 2rem;
		font-family: var(--font-sans);
		line-height: 1.7;
	}

	.copyable-content :global(h1),
	.copyable-content :global(h2),
	.copyable-content :global(h3) {
		margin-top: 1.5rem;
		margin-bottom: 0.75rem;
		line-height: 1.3;
	}

	.copyable-content :global(h2) {
		font-size: 1.5rem;
	}

	.copyable-content :global(h3) {
		font-size: 1.25rem;
	}

	.copyable-content :global(p) {
		margin-bottom: 1rem;
	}

	.copyable-content :global(a) {
		color: var(--amber-dark);
		text-decoration: underline;
	}

	.copyable-content :global(strong) {
		font-weight: 600;
	}

	.copyable-content :global(ul),
	.copyable-content :global(ol) {
		margin-bottom: 1rem;
		padding-left: 1.5rem;
	}

	.copyable-content :global(li) {
		margin-bottom: 0.5rem;
	}

	.copyable-content :global(img) {
		max-width: 100%;
		height: auto;
		border-radius: var(--radius-md);
		margin: 1rem 0;
	}

	.copyable-content :global(blockquote) {
		border-left: 3px solid var(--amber-dark);
		padding-left: 1rem;
		margin: 1rem 0;
		color: var(--text-secondary);
		font-style: italic;
	}

	/* Footer */
	.crosspost-footer {
		margin-top: 2rem;
		padding-top: 2rem;
		border-top: 1px solid rgba(15, 23, 42, 0.08);
	}

	.back-link {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		font-weight: 600;
		color: var(--text-secondary);
		text-decoration: none;
		transition: all var(--duration-fast) var(--ease-out);
	}

	.back-link:hover {
		color: var(--amber-dark);
		gap: 0.75rem;
	}

	/* Spinning animation for loading state */
	@keyframes spin {
		from { transform: rotate(0deg); }
		to { transform: rotate(360deg); }
	}

	.spinning {
		animation: spin 1s linear infinite;
	}

	/* Toast */
	.toast {
		position: fixed;
		bottom: 2rem;
		left: 50%;
		transform: translateX(-50%) translateY(100%);
		background: var(--slate-dark);
		color: white;
		padding: 0.75rem 1.5rem;
		border-radius: var(--radius-lg);
		font-weight: 500;
		opacity: 0;
		transition: all 0.3s ease;
		z-index: 1000;
	}

	.toast.show {
		transform: translateX(-50%) translateY(0);
		opacity: 1;
	}

	/* Responsive */
	@media (max-width: 768px) {
		article {
			padding: var(--space-lg) var(--space-md);
		}

		.crosspost-header h1 {
			font-size: 1.5rem;
		}

		.copyable-content {
			padding: 1.25rem;
		}

		.actions {
			flex-direction: column;
			align-items: stretch;
		}

		.copy-btn,
		.original-link {
			justify-content: center;
		}
	}
</style>

---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';

interface Recommendation {
	id: string;
	title: string;
	position: 'yes' | 'no' | 'candidate';
	candidate?: string;
	summary: string;
}

type Props = CollectionEntry<'blog'>['data'] & {
	recommendations?: Recommendation[];
};

const { title, description, pubDate, updatedDate, heroImage, recommendations = [] } = Astro.props;

// Group recommendations by type
const props = recommendations.filter(r => r.id.toLowerCase().startsWith('prop'));
const races = recommendations.filter(r => !r.id.toLowerCase().startsWith('prop'));
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={heroImage} />
	</head>
	<body>
		<Header />
		<main class="voter-guide">
			<article>
				<header class="guide-header">
					<span class="guide-label">Voter Guide</span>
					<h1>{title}</h1>
					<p class="description">{description}</p>
					<div class="meta">
						<FormattedDate date={pubDate} />
						{updatedDate && (
							<span class="updated">
								(Updated <FormattedDate date={updatedDate} />)
							</span>
						)}
					</div>
				</header>

				{recommendations.length > 0 && (
					<section class="ballot-summary">
						<h2 class="ballot-title">Quick reference</h2>
						<div class="ballot-grid">
							{races.length > 0 && (
								<div class="ballot-section">
									<h3 class="section-label">Races</h3>
									<div class="tiles">
										{races.map((rec) => (
											<a href={`#${rec.id}`} class="ballot-tile candidate">
												<span class="tile-id">{rec.id}</span>
												<span class="tile-position">{rec.candidate}</span>
											</a>
										))}
									</div>
								</div>
							)}
							{props.length > 0 && (
								<div class="ballot-section">
									<h3 class="section-label">Propositions</h3>
									<div class="tiles">
										{props.map((rec) => (
											<a href={`#${rec.id}`} class={`ballot-tile ${rec.position}`}>
												<span class="tile-id">{rec.id}</span>
												<span class="tile-position">{rec.position.toUpperCase()}</span>
											</a>
										))}
									</div>
								</div>
							)}
						</div>
					</section>
				)}

				{recommendations.length > 0 && (
					<section class="recommendations-grid">
						{recommendations.map((rec) => (
							<div id={rec.id} class={`rec-card ${rec.position}`}>
								<div class="rec-header">
									<span class={`rec-badge ${rec.position}`}>
										{rec.position === 'candidate' ? rec.candidate : rec.position.toUpperCase()}
									</span>
									<div class="rec-info">
										<span class="rec-id">{rec.id}</span>
										<h3 class="rec-title">{rec.title}</h3>
									</div>
								</div>
								<p class="rec-summary">{rec.summary}</p>
							</div>
						))}
					</section>
				)}

				<div class="prose voter-guide-prose">
					<slot />
				</div>

				<footer class="article-footer">
					<a href="/blog" class="back-link">
						<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
							<path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
						</svg>
						Back to all posts
					</a>
				</footer>
			</article>
		</main>
		<Footer />
	</body>
</html>

<style>
	/* Voter Guide - uses site theme with vote-specific colors */
	.voter-guide {
		--vote-yes: #4d7c0f;
		--vote-yes-bg: #ecfccb;
		--vote-yes-border: #bef264;
		--vote-no: #b91c1c;
		--vote-no-bg: #fee2e2;
		--vote-no-border: #fca5a5;
		--vote-candidate: var(--ink);
		--vote-candidate-bg: var(--cream-dark);
		--vote-candidate-border: rgba(15, 23, 42, 0.15);
	}

	main.voter-guide {
		max-width: 100%;
		padding: 0;
	}

	article {
		max-width: 800px;
		margin: 0 auto;
		padding: var(--space-xl) var(--space-lg);
	}

	/* Guide Header - matches BlogPost style */
	.guide-header {
		text-align: center;
		margin-bottom: 3rem;
		padding-bottom: 2rem;
		border-bottom: 1px solid rgba(15, 23, 42, 0.08);
	}

	.guide-label {
		display: inline-block;
		font-size: 0.75rem;
		font-weight: 600;
		letter-spacing: 0.1em;
		text-transform: uppercase;
		padding: 0.375rem 0.875rem;
		background: var(--amber-glow);
		color: var(--amber-dark);
		border-radius: var(--radius-full);
		margin-bottom: 1.5rem;
	}

	.guide-header h1 {
		font-size: 2.75rem;
		line-height: 1.2;
		margin-bottom: 1rem;
		letter-spacing: -0.03em;
	}

	.description {
		font-size: 1.25rem;
		color: var(--text-secondary);
		max-width: 600px;
		margin: 0 auto 1rem;
		line-height: 1.6;
	}

	.meta {
		font-size: 0.9375rem;
		color: var(--text-muted);
	}

	.updated {
		font-style: italic;
	}

	/* Ballot Summary */
	.ballot-summary {
		background: var(--cream-dark);
		border: 1px solid rgba(15, 23, 42, 0.08);
		border-radius: var(--radius-lg);
		padding: 1.5rem;
		margin-bottom: 2.5rem;
	}

	.ballot-title {
		font-size: 1.25rem;
		margin-bottom: 1.25rem;
		padding-bottom: 0.75rem;
		border-bottom: 1px solid rgba(15, 23, 42, 0.08);
	}

	.ballot-section {
		margin-bottom: 1.25rem;
	}

	.ballot-section:last-child {
		margin-bottom: 0;
	}

	.section-label {
		font-family: 'Source Sans 3', sans-serif;
		font-size: 0.75rem;
		font-weight: 600;
		letter-spacing: 0.1em;
		text-transform: uppercase;
		color: var(--text-muted);
		margin-bottom: 0.625rem;
	}

	.tiles {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}

	.ballot-tile {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 0.5rem 0.875rem;
		border-radius: var(--radius-md);
		text-decoration: none;
		transition: all var(--duration-fast) var(--ease-out);
		min-width: 72px;
		border: 1px solid;
	}

	.ballot-tile.yes {
		background: var(--vote-yes-bg);
		border-color: var(--vote-yes-border);
		color: var(--vote-yes);
	}

	.ballot-tile.no {
		background: var(--vote-no-bg);
		border-color: var(--vote-no-border);
		color: var(--vote-no);
	}

	.ballot-tile.candidate {
		background: var(--vote-candidate-bg);
		border-color: var(--vote-candidate-border);
		color: var(--vote-candidate);
	}

	.ballot-tile:hover {
		transform: translateY(-2px);
		box-shadow: var(--shadow-sm);
	}

	.tile-id {
		font-size: 0.6875rem;
		font-weight: 600;
		letter-spacing: 0.05em;
		opacity: 0.7;
		text-transform: uppercase;
	}

	.tile-position {
		font-size: 0.9375rem;
		font-weight: 700;
		letter-spacing: 0.02em;
	}

	/* Recommendations Grid */
	.recommendations-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
		gap: 1rem;
		margin-bottom: 3rem;
	}

	.rec-card {
		background: white;
		border-radius: var(--radius-lg);
		padding: 1.25rem;
		box-shadow: var(--shadow-sm);
		border: 1px solid rgba(0, 0, 0, 0.06);
		display: flex;
		flex-direction: column;
		transition: all var(--duration-fast) var(--ease-out);
		border-left: 3px solid;
	}

	.rec-card.yes {
		border-left-color: var(--vote-yes);
	}

	.rec-card.no {
		border-left-color: var(--vote-no);
	}

	.rec-card.candidate {
		border-left-color: var(--amber);
	}

	.rec-card:hover {
		box-shadow: var(--shadow-md);
	}

	.rec-header {
		display: flex;
		gap: 0.875rem;
		margin-bottom: 0.75rem;
		align-items: flex-start;
	}

	.rec-badge {
		flex-shrink: 0;
		font-size: 0.75rem;
		font-weight: 700;
		letter-spacing: 0.05em;
		padding: 0.25rem 0.5rem;
		border-radius: var(--radius-sm);
	}

	.rec-badge.yes {
		background: var(--vote-yes);
		color: white;
	}

	.rec-badge.no {
		background: var(--vote-no);
		color: white;
	}

	.rec-badge.candidate {
		background: var(--ink);
		color: white;
		font-size: 0.6875rem;
		max-width: 90px;
		text-align: center;
		line-height: 1.3;
	}

	.rec-info {
		flex: 1;
		min-width: 0;
	}

	.rec-id {
		font-size: 0.6875rem;
		font-weight: 600;
		letter-spacing: 0.1em;
		text-transform: uppercase;
		color: var(--text-muted);
	}

	.rec-title {
		font-family: 'Playfair Display', serif;
		font-size: 0.9375rem;
		font-weight: 600;
		margin: 0.125rem 0 0;
		line-height: 1.35;
		color: var(--ink);
	}

	.rec-summary {
		font-size: 0.875rem;
		color: var(--text-secondary);
		line-height: 1.5;
		margin: 0;
	}

	/* Prose adjustments for voter guides */
	.voter-guide-prose {
		max-width: 100%;
	}

	.voter-guide-prose :global(h2) {
		margin-top: 3rem;
		padding-top: 2rem;
		border-top: 2px solid rgba(15, 23, 42, 0.08);
	}

	.voter-guide-prose :global(h3) {
		margin-top: 2rem;
	}

	/* Article Footer */
	.article-footer {
		margin-top: 4rem;
		padding-top: 2rem;
		border-top: 1px solid rgba(15, 23, 42, 0.08);
	}

	.back-link {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		font-weight: 600;
		color: var(--text-secondary);
		text-decoration: none;
		transition: all var(--duration-fast) var(--ease-out);
	}

	.back-link:hover {
		color: var(--amber-dark);
		gap: 0.75rem;
	}

	/* Responsive */
	@media (max-width: 768px) {
		article {
			padding: var(--space-lg) var(--space-md);
		}

		.guide-header h1 {
			font-size: 2rem;
		}

		.description {
			font-size: 1.125rem;
		}

		.ballot-summary {
			padding: 1.25rem;
		}

		.recommendations-grid {
			grid-template-columns: 1fr;
		}
	}
</style>

---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';

const elections = await getCollection('elections');

// Define jurisdiction hierarchy (order matters)
const jurisdictionOrder = ['California', 'San Francisco', 'Ventura County', 'Oxnard'];

// Helper to extract just month/year from title for cleaner display
function getElectionLabel(title: string): string {
	const cleaned = title
		.replace(/.*voter guide:\s*/i, '')
		.replace(/.*recall election:\s*/i, 'Recall: ')
		.replace(/.*ADEM.*guide:\s*/i, 'ADEM: ')
		.trim();
	return cleaned;
}

// Helper to get election type badge
function getElectionType(title: string, date: Date): { label: string; className: string } {
	const titleLower = title.toLowerCase();
	const month = date.getMonth();

	if (titleLower.includes('recall')) {
		return { label: 'Special', className: 'type-special' };
	}
	if (titleLower.includes('adem')) {
		return { label: 'Party', className: 'type-party' };
	}
	if (month === 5 || month === 2) {
		return { label: 'Primary', className: 'type-primary' };
	}
	return { label: 'General', className: 'type-general' };
}

// Determine jurisdiction for an election
function getJurisdiction(election: typeof elections[0]): string {
	const location = election.data.location;
	if (location !== 'California') return location;

	const title = election.data.title.toLowerCase();
	if (title.includes('san francisco')) return 'San Francisco';
	if (title.includes('ventura county')) return 'Ventura County';
	if (title.includes('oxnard')) return 'Oxnard';
	return 'California';
}

// Build processed election type
type ProcessedElection = {
	slug: string;
	label: string;
	jurisdiction: string;
	type: { label: string; className: string };
	date: Date;
	dateKey: string; // e.g. "2020-11" for grouping
};

// Process all elections
const processedElections: ProcessedElection[] = elections.map(election => {
	const date = new Date(election.data.electionDate);
	const jurisdiction = getJurisdiction(election);
	return {
		slug: election.id.replace('/index', ''),
		label: getElectionLabel(election.data.title),
		jurisdiction,
		type: getElectionType(election.data.title, date),
		date,
		dateKey: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`
	};
});

// === VIEW 1: By Jurisdiction ===
type YearData = {
	year: number;
	elections: ProcessedElection[];
};

type JurisdictionData = {
	name: string;
	count: number;
	years: YearData[];
};

const jurisdictionData: JurisdictionData[] = [];

for (const jurisdiction of jurisdictionOrder) {
	const jurisdictionElections = processedElections.filter(e => e.jurisdiction === jurisdiction);

	if (jurisdictionElections.length === 0) continue;

	// Sort by date descending
	jurisdictionElections.sort((a, b) => b.date.getTime() - a.date.getTime());

	// Group by year
	const yearMap = new Map<number, ProcessedElection[]>();
	for (const election of jurisdictionElections) {
		const year = election.date.getFullYear();
		if (!yearMap.has(year)) yearMap.set(year, []);
		yearMap.get(year)!.push(election);
	}

	const years = Array.from(yearMap.entries())
		.sort(([a], [b]) => b - a)
		.map(([year, elections]) => ({ year, elections }));

	jurisdictionData.push({
		name: jurisdiction,
		count: jurisdictionElections.length,
		years
	});
}

// === VIEW 2: By Election Date ===
type ElectionDateData = {
	dateKey: string;
	displayDate: string;
	type: { label: string; className: string };
	elections: ProcessedElection[];
};

const electionDateMap = new Map<string, ProcessedElection[]>();
for (const election of processedElections) {
	if (!electionDateMap.has(election.dateKey)) {
		electionDateMap.set(election.dateKey, []);
	}
	electionDateMap.get(election.dateKey)!.push(election);
}

// Sort elections within each date group by jurisdiction order
for (const [_, list] of electionDateMap) {
	list.sort((a, b) => {
		const aIdx = jurisdictionOrder.indexOf(a.jurisdiction);
		const bIdx = jurisdictionOrder.indexOf(b.jurisdiction);
		return aIdx - bIdx;
	});
}

const electionDateData: ElectionDateData[] = Array.from(electionDateMap.entries())
	.sort(([a], [b]) => b.localeCompare(a)) // Most recent first
	.map(([dateKey, elections]) => {
		const firstElection = elections[0];
		const date = firstElection.date;
		const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
			'July', 'August', 'September', 'October', 'November', 'December'];
		return {
			dateKey,
			displayDate: `${monthNames[date.getMonth()]} ${date.getFullYear()}`,
			type: firstElection.type,
			elections
		};
	});
---

<html lang="en">
	<head>
		<BaseHead title="Voter Guides" description="My recommendations for California elections since 2016." />
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
	</head>
	<body>
		<Header />
		<main>
			<header class="page-header">
				<div class="header-content">
					<h1>Voter guides</h1>
					<p class="subtitle">California election recommendations since 2016</p>
				</div>
				<div class="header-controls">
					<div class="view-toggle" role="tablist">
						<button class="toggle-btn active" data-view="date" role="tab" aria-selected="true">
							By election
						</button>
						<button class="toggle-btn" data-view="jurisdiction" role="tab" aria-selected="false">
							By jurisdiction
						</button>
					</div>
				</div>
			</header>

			<!-- View: By Election Date -->
			<div class="archive view-date active" id="view-date">
				{electionDateData.map((dateGroup) => (
					<section class="election-date-group">
						<header class="date-header">
							<div class="date-info">
								<h2>{dateGroup.displayDate}</h2>
								<span class={`election-type ${dateGroup.type.className}`}>{dateGroup.type.label}</span>
							</div>
							<span class="count">{dateGroup.elections.length} {dateGroup.elections.length === 1 ? 'guide' : 'guides'}</span>
						</header>

						<div class="elections-list">
							{dateGroup.elections.map((election) => (
								<a href={`/voter-guides/${election.slug}/`} class="election-item">
									<span class="jurisdiction-badge">{election.jurisdiction}</span>
									<span class="election-label">{election.jurisdiction === 'California' ? 'Statewide' : election.jurisdiction}</span>
									<svg class="arrow" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
										<path d="M5 12h14M12 5l7 7-7 7"/>
									</svg>
								</a>
							))}
						</div>
					</section>
				))}
			</div>

			<!-- View: By Jurisdiction -->
			<div class="archive view-jurisdiction" id="view-jurisdiction">
				{jurisdictionData.map((jurisdiction) => (
					<section class="jurisdiction">
						<header class="jurisdiction-header">
							<h2>{jurisdiction.name}</h2>
							<span class="count">{jurisdiction.count} {jurisdiction.count === 1 ? 'election' : 'elections'}</span>
						</header>

						<div class="timeline">
							{jurisdiction.years.map(({ year, elections }) => (
								<div class="year-group">
									<div class="year-marker">
										<span class="year">{year}</span>
									</div>
									<div class="elections">
										{elections.map((election) => (
											<a href={`/voter-guides/${election.slug}/`} class="election-item">
												<span class={`election-type ${election.type.className}`}>{election.type.label}</span>
												<span class="election-label">{election.label}</span>
												<svg class="arrow" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
													<path d="M5 12h14M12 5l7 7-7 7"/>
												</svg>
											</a>
										))}
									</div>
								</div>
							))}
						</div>
					</section>
				))}
			</div>
		</main>
		<Footer />

		<script>
			const toggleBtns = document.querySelectorAll('.toggle-btn');
			const viewDate = document.getElementById('view-date');
			const viewJurisdiction = document.getElementById('view-jurisdiction');

			toggleBtns.forEach(btn => {
				btn.addEventListener('click', () => {
					const view = btn.getAttribute('data-view');

					// Update buttons
					toggleBtns.forEach(b => {
						b.classList.remove('active');
						b.setAttribute('aria-selected', 'false');
					});
					btn.classList.add('active');
					btn.setAttribute('aria-selected', 'true');

					// Update views
					if (view === 'date') {
						viewDate?.classList.add('active');
						viewJurisdiction?.classList.remove('active');
					} else {
						viewDate?.classList.remove('active');
						viewJurisdiction?.classList.add('active');
					}

					// Save preference
					localStorage.setItem('voter-guides-view', view || 'date');
				});
			});

			// Restore saved preference
			const savedView = localStorage.getItem('voter-guides-view');
			if (savedView) {
				const btn = document.querySelector(`.toggle-btn[data-view="${savedView}"]`);
				if (btn) (btn as HTMLButtonElement).click();
			}
		</script>
	</body>
</html>

<style>
	:root {
		--navy: #1a2744;
		--navy-soft: #2d3f5c;
		--slate: #64748b;
		--cream: #faf8f5;
		--cream-dark: #f0ebe3;
		--amber-accent: #c9973f;
		--amber-soft: #e8d5b0;
	}

	main {
		max-width: 900px;
		margin: 0 auto;
		padding: var(--space-xl) var(--space-lg);
		font-family: 'DM Sans', sans-serif;
	}

	/* Page Header */
	.page-header {
		margin-bottom: 2.5rem;
		padding-bottom: 1.5rem;
		border-bottom: 2px solid var(--navy);
	}

	.header-content h1 {
		font-family: 'Crimson Pro', Georgia, serif;
		font-size: 3rem;
		font-weight: 600;
		color: var(--navy);
		margin: 0 0 0.25rem;
		letter-spacing: -0.02em;
	}

	.subtitle {
		font-size: 1.125rem;
		color: var(--slate);
		margin: 0;
	}

	.header-controls {
		margin-top: 1.5rem;
	}

	/* View Toggle */
	.view-toggle {
		display: inline-flex;
		background: var(--cream);
		border-radius: 6px;
		padding: 4px;
		gap: 4px;
	}

	.toggle-btn {
		padding: 0.5rem 1rem;
		font-size: 0.875rem;
		font-weight: 500;
		color: var(--slate);
		background: transparent;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		transition: all 0.15s ease;
	}

	.toggle-btn:hover {
		color: var(--navy);
	}

	.toggle-btn.active {
		background: white;
		color: var(--navy);
		box-shadow: 0 1px 3px rgba(0,0,0,0.1);
	}

	/* Archive Views */
	.archive {
		display: none;
		flex-direction: column;
		gap: 2rem;
	}

	.archive.active {
		display: flex;
	}

	/* === By Election Date View === */
	.election-date-group {
		background: white;
		border: 1px solid rgba(26, 39, 68, 0.1);
		border-radius: 8px;
		overflow: hidden;
	}

	.date-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 1.25rem 1.5rem;
		background: linear-gradient(to right, var(--navy), var(--navy-soft));
	}

	.date-info {
		display: flex;
		align-items: center;
		gap: 1rem;
	}

	.date-header h2 {
		font-family: 'Crimson Pro', Georgia, serif;
		font-size: 1.5rem;
		font-weight: 500;
		color: white;
		margin: 0;
	}

	.date-header .count {
		font-size: 0.75rem;
		font-weight: 500;
		color: var(--amber-soft);
		text-transform: uppercase;
		letter-spacing: 0.1em;
	}

	.elections-list {
		display: flex;
		flex-direction: column;
	}

	.view-date .election-item {
		display: flex;
		align-items: center;
		gap: 1rem;
		padding: 1rem 1.5rem;
		text-decoration: none;
		transition: background-color 0.15s ease;
		border-bottom: 1px solid rgba(26, 39, 68, 0.06);
	}

	.view-date .election-item:last-child {
		border-bottom: none;
	}

	.view-date .election-item:hover {
		background: var(--cream);
	}

	.view-date .election-item:hover .arrow {
		transform: translateX(3px);
		opacity: 1;
	}

	.jurisdiction-badge {
		flex-shrink: 0;
		min-width: 100px;
		padding: 0.25rem 0.625rem;
		font-size: 0.6875rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		border-radius: 3px;
		background: var(--cream-dark);
		color: var(--navy-soft);
		text-align: center;
	}

	.view-date .election-label {
		flex: 1;
		font-size: 0.9375rem;
		font-weight: 500;
		color: var(--navy);
	}

	/* === By Jurisdiction View === */
	.jurisdiction {
		background: white;
		border: 1px solid rgba(26, 39, 68, 0.1);
		border-radius: 8px;
		overflow: hidden;
	}

	.jurisdiction-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 1.25rem 1.5rem;
		background: linear-gradient(to right, var(--navy), var(--navy-soft));
	}

	.jurisdiction-header h2 {
		font-family: 'Crimson Pro', Georgia, serif;
		font-size: 1.5rem;
		font-weight: 500;
		color: white;
		margin: 0;
	}

	.jurisdiction-header .count {
		font-size: 0.75rem;
		font-weight: 500;
		color: var(--amber-soft);
		text-transform: uppercase;
		letter-spacing: 0.1em;
	}

	/* Timeline */
	.timeline {
		padding: 0.5rem 0;
	}

	.year-group {
		display: grid;
		grid-template-columns: 80px 1fr;
		border-bottom: 1px solid rgba(26, 39, 68, 0.06);
	}

	.year-group:last-child {
		border-bottom: none;
	}

	.year-marker {
		display: flex;
		align-items: flex-start;
		justify-content: center;
		padding: 1rem 0;
		background: var(--cream);
		border-right: 1px solid rgba(26, 39, 68, 0.08);
	}

	.year {
		font-family: 'Crimson Pro', Georgia, serif;
		font-size: 1.125rem;
		font-weight: 600;
		color: var(--navy);
	}

	.elections {
		display: flex;
		flex-direction: column;
	}

	.view-jurisdiction .election-item {
		display: flex;
		align-items: center;
		gap: 1rem;
		padding: 0.875rem 1.25rem;
		text-decoration: none;
		transition: background-color 0.15s ease;
		border-bottom: 1px solid rgba(26, 39, 68, 0.04);
	}

	.view-jurisdiction .election-item:last-child {
		border-bottom: none;
	}

	.view-jurisdiction .election-item:hover {
		background: var(--cream);
	}

	.view-jurisdiction .election-item:hover .arrow {
		transform: translateX(3px);
		opacity: 1;
	}

	/* Shared Styles */
	.election-type {
		flex-shrink: 0;
		padding: 0.25rem 0.625rem;
		font-size: 0.6875rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		border-radius: 3px;
	}

	.type-general {
		background: var(--navy);
		color: white;
	}

	.type-primary {
		background: var(--amber-soft);
		color: var(--navy);
	}

	.type-special {
		background: #fce7f3;
		color: #9d174d;
	}

	.type-party {
		background: #dbeafe;
		color: #1e40af;
	}

	.view-jurisdiction .election-label {
		flex: 1;
		font-size: 0.9375rem;
		font-weight: 500;
		color: var(--navy);
	}

	.arrow {
		flex-shrink: 0;
		color: var(--slate);
		opacity: 0;
		transition: all 0.15s ease;
	}

	/* Responsive */
	@media (max-width: 640px) {
		.page-header h1 {
			font-size: 2.25rem;
		}

		.year-group {
			grid-template-columns: 60px 1fr;
		}

		.year-marker {
			padding: 0.75rem 0;
		}

		.year {
			font-size: 1rem;
		}

		.view-jurisdiction .election-item {
			padding: 0.75rem 1rem;
		}

		.election-type {
			font-size: 0.625rem;
			padding: 0.2rem 0.5rem;
		}

		.view-jurisdiction .election-label,
		.view-date .election-label {
			font-size: 0.875rem;
		}

		.jurisdiction-badge {
			min-width: 80px;
			font-size: 0.625rem;
		}

		.date-info {
			flex-direction: column;
			align-items: flex-start;
			gap: 0.5rem;
		}

		.date-header h2 {
			font-size: 1.25rem;
		}
	}
</style>
